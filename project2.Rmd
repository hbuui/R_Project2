---
title: "Project2"
author: "Hien Bui, Ana Martinez"
date: "2025-05-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# loading necessary libraries
library(dplyr)    
library(tidyr)    
library(lubridate)
library(stringr)  
library(leaflet)
library(htmltools)
library(knitr)
library(kableExtra)
library(ggplot2)
library(scales)
library(cowplot)
```

USPRT
```{r}
# downloading and load the US confirmed cases/death data into a data frame
url_us_confirmed <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"
url_us_deaths <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv"
us_confirmed_df <- read.csv(url_us_confirmed, stringsAsFactors = FALSE)
message("US Confirmed Cases data downloaded.")
us_deaths_df <- read.csv(url_us_deaths, stringsAsFactors = FALSE)
message("US Deaths data downloaded.")
```
WHO
```{r}
# downloading and load the GLOBAL confirmed cases/death data into a data frame
url_global_confirmed <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"
url_global_deaths <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"
global_confirmed_df <- read.csv(url_global_confirmed, stringsAsFactors = FALSE)
message("GLOBAl Confirmed Cases data downloaded.")
global_deaths_df <- read.csv(url_global_deaths, stringsAsFactors = FALSE)
message("GLOBAL Deaths Cases data downloaded.")
```

## **Objective 1: Global Map** 

```{r}
# looking at all column names that look like dates and parse them
date_col_names_in_df <- names(global_confirmed_df)[5:ncol(global_confirmed_df)]

potential_date_cols <- date_col_names_in_df[startsWith(date_col_names_in_df, "X") & grepl("\\.", date_col_names_in_df)]

clean_date_strings <- sub("^X", "", potential_date_cols)

parsed_dates <- lubridate::parse_date_time(clean_date_strings, orders = c("m.d.y", "m.d.Y"))

most_recent_date_global <- max(parsed_dates, na.rm = TRUE)

most_recent_col_name_r <- potential_date_cols[which(parsed_dates == most_recent_date_global)][1]

if (!most_recent_col_name_r %in% names(global_confirmed_df)) {
  stop("Failed to robustly identify the most recent date column in global_confirmed_df. Check raw data column names.")
}

message(paste("Most recent date identified:", format(most_recent_date_global, "%Y-%m-%d")))
message(paste("Corresponding column name:", most_recent_col_name_r))

# selecting relevant columns and pivot to long format for easier processing
global_confirmed_long <- global_confirmed_df %>%
  select(Province.State, `Country.Region`, Lat, Long, all_of(most_recent_col_name_r)) %>%
  rename(Confirmed_Cases = all_of(most_recent_col_name_r))

global_deaths_long <- global_deaths_df %>%
  select(Province.State, `Country.Region`, Lat, Long, all_of(most_recent_col_name_r)) %>%
  rename(Deaths_Cases = all_of(most_recent_col_name_r))

# combine confirmed and deaths data for the most recent date
global_cases_combined <- full_join(
  global_confirmed_long,
  global_deaths_long,
  by = c("Province.State", "Country.Region", "Lat", "Long") 
) %>%
  mutate(Total_Cases = Confirmed_Cases + Deaths_Cases) %>%
  replace_na(list(Total_Cases = 0, Confirmed_Cases = 0, Deaths_Cases = 0))


# aggregate to country level by summing cases and calculate mean lat & long for each country
country_level_data <- global_cases_combined %>%
  group_by(`Country.Region`) %>%
  summarize(
    Total_Cases = sum(Total_Cases, na.rm = TRUE),
    Total_Confirmations = sum(Confirmed_Cases, na.rm = TRUE),
    Total_Deaths = sum(Deaths_Cases, na.rm = TRUE),
    Avg_Lat = mean(Lat, na.rm = TRUE),
    Avg_Long = mean(Long, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(!is.na(Avg_Lat) & !is.na(Avg_Long))

# calculating the quartiles for the Total_Cases to categorize magnitudes
quantiles_cases <- quantile(country_level_data$Total_Cases, probs = c(0.25, 0.50, 0.75), na.rm = TRUE)

# assign magnitude categories and colors based on the calculated quartiles.
country_level_data <- country_level_data %>%
  mutate(
    Magnitude_Category = case_when(
      Total_Cases <= quantiles_cases[1] ~ "Low",
      Total_Cases > quantiles_cases[1] & Total_Cases <= quantiles_cases[3] ~ "Neutral",
      Total_Cases > quantiles_cases[3] ~ "High",
      TRUE ~ "Unknown"
    ),
    Color = case_when(
      Magnitude_Category == "Low" ~ "blue",
      Magnitude_Category == "Neutral" ~ "gray",
      Magnitude_Category == "High" ~ "red",
      TRUE ~ "black"
    )
  )

# adjust the 'radius_scale_factor'
radius_scale_factor <- 300 

global_covid_map <- country_level_data %>%
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%

  addCircleMarkers(
    ~Avg_Long,
    ~Avg_Lat,
    radius = ~sqrt(Total_Cases) / radius_scale_factor,
    fillColor = ~Color,
    fillOpacity = 0.7,
    stroke = TRUE,
    color = "black",
    weight = 0.5,

    # displays country name when mouse hovers over the marker
    label = ~htmlEscape(Country.Region), 

    # displays a popup with detailed information when marker is clicked
    popup = ~paste0(
      "<b>Country:</b> ", Country.Region, "<br/>", 
      "<b>Total Confirmed:</b> ", format(Total_Confirmations, big.mark = ","), "<br/>",
      "<b>Total Deaths:</b> ", format(Total_Deaths, big.mark = ","), "<br/>",
      "<b>Total Cases (Conf. + Deaths):</b> ", format(Total_Cases, big.mark = ",")
    )
  )

global_covid_map
```

## **Objective 2: Narrowing Down Hot Spots**

```{r}
# group and summarize the data by country: top 10 countries by confirmed cases and deaths
top_confirmed <- global_confirmed_df %>%
select(`Country.Region`, all_of(most_recent_col_name_r)) %>%
group_by(`Country.Region`) %>%
summarise(Total_Confirmed = sum(.data[[most_recent_col_name_r]], na.rm = TRUE)) %>%
arrange(desc(Total_Confirmed)) %>%
slice(1:10)

top_deaths <- global_deaths_df %>%
select(`Country.Region`, all_of(most_recent_col_name_r)) %>%
group_by(`Country.Region`) %>%
summarise(Total_Deaths = sum(.data[[most_recent_col_name_r]], na.rm = TRUE)) %>%
arrange(desc(Total_Deaths)) %>%
slice(1:10)

# combine top 10 confirmed and deaths into a single table
hotspot_table <- tibble(
Rank = 1:10,
Country_Confirmed = top_confirmed$`Country.Region`,
Confirmed = top_confirmed$Total_Confirmed,
Country_Deaths = top_deaths$`Country.Region`,
Deaths = top_deaths$Total_Deaths
)

# display table using kable and kableExtra
kable(hotspot_table,
caption = "Top 10 Countries by COVID-19 Confirmed Cases and Deaths",
col.names = c("Rank", "Country (Confirmed)", "Confirmed", "Country (Deaths)", "Deaths"),
format = "html") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"),
full_width = FALSE,
position = "center") %>%
column_spec(1, bold = TRUE) %>%
column_spec(3, color = "blue") %>%
column_spec(5, color = "red")

```

## **Objective 3: Zooming Into Our State**

```{r}
# filter down US confirmed data to focus on Ca and prepare for time-series analysis
ca_confirmed_long <- us_confirmed_df %>%
  filter(Province_State == "California") %>% 
  select(Admin2, Province_State, starts_with("X")) %>% 
  pivot_longer(
    cols = starts_with("X"),        
    names_to = "Date_String",       
    values_to = "Confirmations"      
  ) %>%
  mutate(
    # convert the 'Xm.d.yy' date strings to proper R date objects
    Date = as.Date(sub("^X", "", Date_String), format = "%m.%d.%y"),
    # if NA then replace with a placeholder
    Admin2 = ifelse(is.na(Admin2), "Unassigned_County", Admin2),
    Confirmations = as.numeric(Confirmations)
  ) %>%
  filter(!is.na(Date)) %>% 
  arrange(Admin2, Date) %>% 
  group_by(Admin2) %>%
  mutate(Confirmations = cummax(Confirmations)) %>%
  ungroup()


#  all confirmations across all counties in Ca for each date
ca_state_data <- ca_confirmed_long %>%
  group_by(Date) %>%
  summarize(Total_Confirmations = sum(Confirmations, na.rm = TRUE), .groups = "drop") %>%
  arrange(Date)

# using the most recent date in the dataset to determine the top counties.
most_recent_ca_date <- max(ca_state_data$Date)

# then filter for the most recent date, group by county, and get the top 3 by confirmations.
top_ca_cities_info <- ca_confirmed_long %>%
  filter(Date == most_recent_ca_date) %>%
  group_by(Admin2) %>%
  summarize(Most_Recent_Confirmations = sum(Confirmations, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(Most_Recent_Confirmations)) %>%
  head(3) 

# getting the names of these top 3 cities/counties
top_city_names <- top_ca_cities_info$Admin2

# then filter the long Ca data to include only the top 3 identified counties.
ca_cities_data <- ca_confirmed_long %>%
  filter(Admin2 %in% top_city_names) %>%
  group_by(Admin2, Date) %>%
  summarize(Cases = sum(Confirmations, na.rm = TRUE), .groups = "drop") %>%
  arrange(Admin2, Date)

# highlight significant events to be marked on the plot 
date_sah <- as.Date("2020-03-19") # date of "Self-isolation at Home" (SAH)
date_eua_2nd_dose <- as.Date("2021-01-29") + weeks(6) # 6 weeks after Moderna EUA 
date_delta_dominant <- as.Date("2021-05-11") #  date of delta variant became dominant
date_omicron_dominant <- as.Date("2021-11-26") # date of omicron variant became dominant


# plotting confirmations in Ca
plot_california_state <- ggplot(ca_state_data, aes(x = Date, y = Total_Confirmations)) +
  geom_line(color = "midnightblue", size = 1.2) + 
  geom_point(color = "midnightblue", size = 0.8) + 
  labs(
    title = "COVID-19 confirmations in California",
    x = "Date",
    y = "Confirmations"
  ) +
  scale_y_continuous(labels = scales::comma) + 
  theme_minimal() + 
  # adding vertical lines to mark key dates
  geom_vline(xintercept = date_sah, linetype = "dashed", color = "darkcyan", size = 0.7) +
  geom_vline(xintercept = date_eua_2nd_dose, linetype = "dashed", color = "darkcyan", size = 0.7) +
  geom_vline(xintercept = date_delta_dominant, linetype = "dashed", color = "brown", size = 0.7) +
  geom_vline(xintercept = date_omicron_dominant, linetype = "dashed", color = "brown", size = 0.7) +
  # adding text annotations for the key dates
  annotate("text", x = date_sah, y = max(ca_state_data$Total_Confirmations, na.rm = TRUE) * 0.7,
           label = "SAH", color = "darkcyan", hjust = 1.1, vjust = 1, size = 3) +
  annotate("text", x = date_eua_2nd_dose, y = max(ca_state_data$Total_Confirmations, na.rm = TRUE) * 0.7,
           label = "EUA\n+6 weeks", color = "darkcyan", hjust = -0.1, vjust = 1, size = 3) +
  annotate("text", x = date_delta_dominant, y = max(ca_state_data$Total_Confirmations, na.rm = TRUE) * 0.9,
           label = "Delta", color = "brown", hjust = -0.1, vjust = 1, size = 3) +
  annotate("text", x = date_omicron_dominant, y = max(ca_state_data$Total_Confirmations, na.rm = TRUE) * 0.9,
           label = "Omicron", color = "brown", hjust = 1.1, vjust = 1, size = 3)

plot_california_state

#plotting the top 3 cities in Ca
plot_california_cities <- ggplot(ca_cities_data, aes(x = Date, y = Cases, color = Admin2)) +
  geom_line(size = 1.2) + 
  geom_point(size = 0.8) + 
  labs(
    x = "Date",
    y = "Cases",
    color = "County" 
  ) +
  scale_y_continuous(labels = scales::comma) + 
  theme_minimal() +
  # adding vertical lines to mark key dates 
  geom_vline(xintercept = date_sah, linetype = "dashed", color = "darkcyan", size = 0.7) +
  geom_vline(xintercept = date_eua_2nd_dose, linetype = "dashed", color = "darkcyan", size = 0.7) +
  geom_vline(xintercept = date_delta_dominant, linetype = "dashed", color = "brown", size = 0.7) +
  geom_vline(xintercept = date_omicron_dominant, linetype = "dashed", color = "brown", size = 0.7) +
  # adding text annotations for the key dates 
  annotate("text", x = date_sah, y = max(ca_cities_data$Cases, na.rm = TRUE) * 0.7,
           label = "SAH", color = "darkcyan", hjust = 1.1, vjust = 1, size = 3) +
  annotate("text", x = date_eua_2nd_dose, y = max(ca_cities_data$Cases, na.rm = TRUE) * 0.7,
           label = "EUA\n+6 weeks", color = "darkcyan", hjust = -0.1, vjust = 1, size = 3) +
  annotate("text", x = date_delta_dominant, y = max(ca_cities_data$Cases, na.rm = TRUE) * 0.9,
           label = "Delta", color = "brown", hjust = -0.1, vjust = 1, size = 3) +
  annotate("text", x = date_omicron_dominant, y = max(ca_cities_data$Cases, na.rm = TRUE) * 0.9,
           label = "Omicron", color = "brown", hjust = 1.1, vjust = 1, size = 3)

plot_california_cities

```

## **Objective 4: Digging Deeper**

```{r}
# we need the most recent date column for both confirmed and deaths.
date_col_names_us <- names(us_confirmed_df)[12:ncol(us_confirmed_df)]
potential_date_cols_us <- date_col_names_us[startsWith(date_col_names_us, "X") & grepl("\\.", date_col_names_us)]
clean_date_strings_us <- sub("^X", "", potential_date_cols_us)
parsed_dates_us <- lubridate::parse_date_time(clean_date_strings_us, orders = c("m.d.y", "m.d.Y"))
most_recent_date_us <- max(parsed_dates_us, na.rm = TRUE)
most_recent_col_name_us_confirmed <- potential_date_cols_us[which(parsed_dates_us == most_recent_date_us)][1]

# looking for the most recent date column name from the deaths data
date_col_names_us_deaths <- names(us_deaths_df)[12:ncol(us_deaths_df)]
potential_date_cols_us_deaths <- date_col_names_us_deaths[startsWith(date_col_names_us_deaths, "X") & grepl("\\.", date_col_names_us_deaths)]
clean_date_strings_us_deaths <- sub("^X", "", potential_date_cols_us_deaths)
parsed_dates_us_deaths <- lubridate::parse_date_time(clean_date_strings_us_deaths, orders = c("m.d.y", "m.d.Y"))
most_recent_col_name_us_deaths <- potential_date_cols_us_deaths[which(parsed_dates_us_deaths == most_recent_date_us)][1]


# select relevant columns then combine confirmed and deaths data for the most recent date
us_confirmed_latest <- us_confirmed_df %>%
  select(
    UID, Admin2, Province_State, Combined_Key,
    Confirmed = all_of(most_recent_col_name_us_confirmed)
  )

# getting deaths data with population 
us_deaths_latest <- us_deaths_df %>%
  select(
    UID, Admin2, Province_State, Combined_Key, Population,
    Deaths = all_of(most_recent_col_name_us_deaths)
  )

# using full_join to keep all entries and handle potential mismatches, then filter NAs.
us_data_for_obj4 <- full_join(
  us_confirmed_latest,
  us_deaths_latest,
  by = c("UID", "Admin2", "Province_State", "Combined_Key")
) %>%
  # filter out rows with NA or zero for population, confirmed, or deaths
  filter(
    !is.na(Population) & Population > 0,
    !is.na(Confirmed) & Confirmed > 0,
    !is.na(Deaths) & Deaths > 0
  ) %>%
  # calculate log-transformed values
  mutate(
    Log_Population = log10(Population),
    Log_Confirmed = log10(Confirmed),
    Log_Deaths = log10(Deaths)
  )

# making the first scatter plot: Confirmations Vs. Population
plot_conf_vs_pop <- ggplot(us_data_for_obj4, aes(x = Population, y = Confirmed)) +
  geom_point(color = "midnightblue", alpha = 0.8) + 
  scale_x_log10(labels = scales::comma) + 
  scale_y_log10(labels = scales::comma) + 
  labs(
    title = "Confirmations Vs. Population",
    x = "Population",
    y = "Confirmation Counts"
  ) +
  theme_minimal() +
  scale_x_log10(breaks = c(1024, 16384, 262144, 4194304),
                labels = scales::comma_format()) +
  scale_y_log10(breaks = c(256, 8192, 262144),
                labels = scales::comma_format())


# making the second scatter plot: Deaths Vs. Confirmations
plot_deaths_vs_conf <- ggplot(us_data_for_obj4, aes(x = Confirmed, y = Deaths)) +
  geom_point(color = "darkred", alpha = 0.8) + 
  scale_x_log10(labels = scales::comma) + 
  scale_y_log10(labels = scales::comma) + #
  labs(
    title = "Deaths Vs. Confirmations",
    x = "Confirmed Counts",
    y = "Death Counts"
  ) +
  theme_minimal() +
  scale_x_log10(breaks = c(1024, 16384, 262144, 4194304),
                labels = scales::comma_format()) +
  scale_y_log10(breaks = c(32, 256, 2048, 16384),
                labels = scales::comma_format())


# combining the plots using cowplot and arrange them side-by-side
combined_scatter_plots <- plot_grid(plot_conf_vs_pop, plot_deaths_vs_conf, ncol = 2)

combined_scatter_plots
```